<!DOCTYPE html>
<html lang="zh-CN">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <meta name="description" content="MagicMist">
   <link rel="icon" type="image/x-icon" href="favicon.ico">
   <link rel="apple-touch-icon" href="Mist.png">
   <title>MagicMist</title>
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
           -webkit-tap-highlight-color: transparent;
           -webkit-user-select: none;
           user-select: none;
       }

       html, body {
           width: 100%;
           height: 100%;
           overflow: hidden;
           background: #000000;
           font-family: Impact;
           color: #FFFFFF;
           font-weight: 700;
           position: relative;
           touch-action: none;
       }

       /* 安全区域变量定义 */
       :root {
           --safe-area-inset-top: env(safe-area-inset-top, 0px);
           --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
           --safe-area-inset-left: env(safe-area-inset-left, 0px);
           --safe-area-inset-right: env(safe-area-inset-right, 0px);
       }

       /* 认证界面 */
       #auth-container {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: #000000;
           display: flex;
           flex-direction: column;
           justify-content: center;
           align-items: center;
           padding-top: var(--safe-area-inset-top);
           padding-bottom: var(--safe-area-inset-bottom);
           z-index: 100;
           overflow: hidden;
           transition: opacity 0.3s ease;
       }

       .auth-button-container {
           width: 100%;
           display: flex;
           flex-direction: column;
           justify-content: center;
           align-items: center;
           padding: 20px;
       }

       /* 纯文本按钮样式 - 宽度75% */
       .auth-button {
           background: none;
           color: #FFFFFF;
           border: none;
           border-radius: 0;
           padding: 20px 15px;
           font-size: 52px;
           font-weight: 400;
           cursor: pointer;
           transition: all 0.3s ease;
           font-family: Impact;
           position: relative;
           overflow: hidden;
           letter-spacing: -1px;
           line-height: 0.9;
           text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
           width: 75%;
           max-width: 400px;
       }

       .auth-button:active {
           transform: scale(0.95);
           opacity: 0.7;
       }

       .auth-button:disabled {
           opacity: 0.5;
           cursor: not-allowed;
       }

       .auth-button-loading .button-text-container {
           opacity: 0;
       }

       /* 加载动画 */
       .auth-button-loading::after {
           content: "";
           position: absolute;
           width: 20px;
           height: 20px;
           top: 50%;
           left: 50%;
           margin-left: -10px;
           margin-top: -10px;
           border: 2px solid #FFFFFF;
           border-radius: 50%;
           border-top-color: transparent;
           animation: spin 1s ease infinite;
       }

       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }

       /* 按钮文本容器 */
       .button-text-container {
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           width: 100%;
       }

       /* MISTY主文本 */
       .button-main-text {
           font-size: 1em;
           margin-bottom: 2px;
           width: 100%;
           text-align: center;
       }

       /* IMAGINATION副文本 */
       .button-sub-text {
           font-size: 0.35em;
           letter-spacing: 3px;
           opacity: 0.8;
           width: 100%;
           text-align: center;
       }

       /* 主内容区域 */
       #content-container {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: transparent;
           z-index: 50;
           opacity: 0;
           transition: opacity 0.3s ease;
           overflow: hidden;
       }

       #content-container.active {
           opacity: 1;
           display: block;
       }

       /* 模糊背景层 */
       .blur-background {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-image: url('Mist.png');
           background-size: cover;
           background-position: center;
           background-repeat: no-repeat;
           filter: blur(25px) brightness(0.7);
           z-index: 1;
           transform: scale(1.2);
           -webkit-transform: scale(1.2);
       }

       /* 渐变遮罩层 */
       .gradient-mask {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           z-index: 2;
           pointer-events: none;
           background: 
               radial-gradient(
                   circle at center,
                   transparent 0%,
                   transparent 30%,
                   rgba(0, 0, 0, 0.1) 40%,
                   rgba(0, 0, 0, 0.3) 50%,
                   rgba(0, 0, 0, 0.6) 60%,
                   rgba(0, 0, 0, 0.8) 70%,
                   rgba(0, 0, 0, 0.9) 80%,
                   #000000 100%
               );
       }

       /* 安全区域渐变层 */
       .safe-area-gradient {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           z-index: 3;
           pointer-events: none;
           background: 
               linear-gradient(
                   to bottom,
                   #000000 0%,
                   rgba(0, 0, 0, 0.9) calc(var(--safe-area-inset-top) * 0.2),
                   rgba(0, 0, 0, 0.7) calc(var(--safe-area-inset-top) * 0.4),
                   rgba(0, 0, 0, 0.4) calc(var(--safe-area-inset-top) * 0.6),
                   rgba(0, 0, 0, 0.2) calc(var(--safe-area-inset-top) * 0.8),
                   transparent var(--safe-area-inset-top)
               ),
               linear-gradient(
                   to top,
                   #000000 0%,
                   rgba(0, 0, 0, 0.9) calc(var(--safe-area-inset-bottom) * 0.2),
                   rgba(0, 0, 0, 0.7) calc(var(--safe-area-inset-bottom) * 0.4),
                   rgba(0, 0, 0, 0.4) calc(var(--safe-area-inset-bottom) * 0.6),
                   rgba(0, 0, 0, 0.2) calc(var(--safe-area-inset-bottom) * 0.8),
                   transparent var(--safe-area-inset-bottom)
               );
       }

       /* 主内容布局 */
       .main-content {
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           width: 90%;
           max-width: 700px;
           min-height: 500px;
           text-align: center;
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: flex-start;
           padding: 30px 25px;
           border-radius: 30px;
           overflow: hidden;
           background-color: transparent;
           z-index: 4;
       }

       /* 内容层 */
       .content-layer {
           position: relative;
           z-index: 2;
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: flex-start;
           width: 100%;
           height: 100%;
           padding-top: 10px;
           background: transparent;
       }

       /* 主要图片 - 宽度设为页面75%，增大圆角更圆滑 */
       .content-image {
           width: 75%;
           aspect-ratio: 1;
           background: #333333 url('Mist.png') center/cover no-repeat;
           margin-bottom: 25px;
           border-radius: 50px;
           box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
           position: relative;
           flex-shrink: 0;
           overflow: hidden;
           max-width: 400px;
       }

       /* 文本轮换区域 */
       .text-rotator-container {
           width: 100%;
           margin-top: 5px;
           padding: 15px 0;
           background: transparent;
       }

       .text-rotator {
           width: 100%;
           text-align: center;
           color: #FFFFFF;
           font-size: 48px;
           font-weight: 700;
           font-family: Impact;
           height: 80px;
           overflow: hidden;
           position: relative;
           background-color: transparent;
           border-radius: 15px;
           padding: 0;
           display: flex;
           align-items: center;
           justify-content: center;
           text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
           cursor: pointer;
           transition: all 0.3s ease;
       }

       .text-rotator:hover {
           background-color: rgba(255, 255, 255, 0.1);
       }

       .text-rotator:active {
           transform: scale(0.98);
       }

       .rotating-text {
           position: absolute;
           width: 100%;
           opacity: 0;
           transform: translateY(20px);
           transition: all 0.4s ease;
           font-weight: 700;
           font-family: Impact;
           color: #FFFFFF;
           text-align: center;
           line-height: 1.2;
           text-shadow: inherit;
       }

       .rotating-text.active {
           opacity: 1;
           transform: translateY(0);
       }

       .rotating-text.exiting {
           opacity: 0;
           transform: translateY(-20px);
       }

       /* 模态窗口 */
       .modal-overlay {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0, 0, 0, 0.7);
           z-index: 200;
           justify-content: center;
           align-items: center;
           backdrop-filter: blur(5px);
       }

       .modal-overlay.active {
           display: flex;
       }

       .modal-content {
           background-color: #1a1a1a;
           width: 90%;
           max-width: 500px;
           border-radius: 20px;
           padding: 30px;
           box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
           color: #ffffff;
           display: flex;
           flex-direction: column;
           gap: 20px;
       }

       .modal-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 10px;
       }

       .modal-title {
           font-size: 24px;
           font-weight: 700;
           font-family: Impact;
       }

       .modal-close {
           background: none;
           border: none;
           color: #ffffff;
           font-size: 28px;
           cursor: pointer;
           width: 40px;
           height: 40px;
           display: flex;
           justify-content: center;
           align-items: center;
           border-radius: 50%;
           transition: background-color 0.3s ease;
           font-family: Impact;
       }

       .modal-close:hover {
           background-color: rgba(255, 255, 255, 0.1);
       }

       .modal-section {
           display: flex;
           flex-direction: column;
           gap: 15px;
       }

       .section-title {
           font-size: 18px;
           font-weight: 700;
           margin-bottom: 5px;
           font-family: Impact;
       }

       .image-preview-container {
           display: flex;
           flex-direction: column;
           align-items: center;
           gap: 15px;
       }

       .image-preview {
           width: 150px;
           height: 150px;
           background: #333333 url('Mist.png') center/cover no-repeat;
           border-radius: 15px;
           box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
           overflow: hidden;
       }

       .file-input-wrapper {
           position: relative;
           overflow: hidden;
           display: inline-block;
           width: 100%;
       }

       .file-input-button {
           background-color: #4a4a4a;
           color: white;
           padding: 12px 20px;
           border-radius: 10px;
           cursor: pointer;
           text-align: center;
           font-weight: 600;
           transition: background-color 0.3s ease;
           width: 100%;
           font-family: Impact;
       }

       .file-input-button:hover {
           background-color: #5a5a5a;
       }

       .file-input {
           position: absolute;
           left: 0;
           top: 0;
           opacity: 0;
           width: 100%;
           height: 100%;
           cursor: pointer;
       }

       .text-input-container {
           display: flex;
           flex-direction: column;
           gap: 10px;
       }

       .text-input {
           background-color: #2a2a2a;
           border: 2px solid #3a3a3a;
           border-radius: 10px;
           padding: 12px 15px;
           color: white;
           font-size: 16px;
           font-family: Impact;
           transition: border-color 0.3s ease;
       }

       .text-input:focus {
           outline: none;
           border-color: #5a5a5a;
       }

       .modal-buttons {
           display: flex;
           gap: 15px;
           margin-top: 10px;
       }

       .modal-button {
           flex: 1;
           padding: 12px 20px;
           border-radius: 10px;
           border: none;
           font-weight: 600;
           cursor: pointer;
           transition: all 0.3s ease;
           font-family: Impact;
       }

       .modal-button.save {
           background-color: #4CAF50;
           color: white;
       }

       .modal-button.save:hover {
           background-color: #45a049;
       }

       .modal-button.cancel {
           background-color: #757575;
           color: white;
       }

       .modal-button.cancel:hover {
           background-color: #666666;
       }

       /* 响应式设计 */
       @media (max-width: 768px) {
           .content-image {
               width: 75%;
               border-radius: 40px;
               max-width: 300px;
           }
           
           .text-rotator {
               font-size: 40px;
               height: 70px;
           }
           
           .main-content {
               padding: 25px 20px;
               border-radius: 25px;
               min-height: 450px;
           }
           
           .text-rotator-container {
               margin-top: 5px;
               padding: 10px 0;
           }
           
           .modal-content {
               padding: 25px;
           }
       }

       @media (max-width: 480px) {
           .content-image {
               width: 75%;
               border-radius: 35px;
               max-width: 250px;
           }
           
           .text-rotator {
               font-size: 34px;
               height: 60px;
           }
           
           .main-content {
               padding: 20px 15px;
               border-radius: 20px;
               min-height: 400px;
           }
           
           .text-rotator-container {
               margin-top: 5px;
               padding: 10px 0;
           }
           
           .modal-content {
               padding: 20px;
           }
           
           .modal-buttons {
               flex-direction: column;
           }
       }
       
       /* 防止滚动 */
       .no-scroll {
           overflow: hidden;
       }
       
       /* 为不支持env()的浏览器提供回退 */
       @supports not (top: env(safe-area-inset-top)) {
           :root {
               --safe-area-inset-top: constant(safe-area-inset-top, 0px);
               --safe-area-inset-bottom: constant(safe-area-inset-bottom, 0px);
               --safe-area-inset-left: constant(safe-area-inset-left, 0px);
               --safe-area-inset-right: constant(safe-area-inset-right, 0px);
           }
       }
   </style>
</head>
<body class="no-scroll">
   <!-- Face ID认证界面 -->
   <div id="auth-container">
       <div class="auth-button-container">
           <button class="auth-button" id="authButton">
               <div class="button-text-container">
                   <div class="button-main-text">MISTY</div>
                   <div class="button-sub-text">IMAGINATION</div>
               </div>
           </button>
       </div>
   </div>

   <!-- 主内容区域 -->
   <div id="content-container">
       <div class="main-content">
           <div class="content-layer">
               <div class="content-image" role="img" aria-label="MagicMist应用图标"></div>
               <div class="text-rotator-container">
                   <div class="text-rotator" id="textRotator">
                       <!-- 文本将通过JavaScript动态添加 -->
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- 模糊背景层 -->
   <div class="blur-background"></div>
   
   <!-- 渐变遮罩层 -->
   <div class="gradient-mask"></div>
   
   <!-- 安全区域渐变层 -->
   <div class="safe-area-gradient"></div>

   <!-- 模态窗口 -->
   <div class="modal-overlay" id="modalOverlay">
       <div class="modal-content">
           <div class="modal-header">
               <h2 class="modal-title">自定义内容</h2>
               <button class="modal-close" id="modalClose">&times;</button>
           </div>
           
           <div class="modal-section">
               <h3 class="section-title">更换图片</h3>
               <div class="image-preview-container">
                   <div class="image-preview" id="imagePreview"></div>
                   <div class="file-input-wrapper">
                       <div class="file-input-button">选择图片</div>
                       <input type="file" class="file-input" id="imageInput" accept="image/*">
                   </div>
               </div>
           </div>
           
           <div class="modal-section">
               <h3 class="section-title">修改轮换文本</h3>
               <div class="text-input-container">
                   <input type="text" class="text-input" id="textInput1" placeholder="文本 1" maxlength="20">
                   <input type="text" class="text-input" id="textInput2" placeholder="文本 2" maxlength="20">
               </div>
           </div>
           
           <div class="modal-buttons">
               <button class="modal-button save" id="saveButton">保存</button>
               <button class="modal-button cancel" id="cancelButton">取消</button>
           </div>
       </div>
   </div>

   <script>
       // 应用配置
       const CONFIG = {
           webauthn: {
               rpName: "MagicMist",
               userName: "霧@MagicMist",
               userDisplayName: "霧@MagicMist'",
               timeout: 60000
           },
           
           textRotation: {
               texts: [
                   "霧",
                   "Mist"
               ],
               interval: 1200,
               transitionDuration: 400
           }
       };
       
       // 应用状态管理
       const AppState = {
           isAuthenticated: false,
           credentialId: null,
           customImage: null,
           customTexts: [...CONFIG.textRotation.texts]
       };
       
       // DOM元素引用
       const DOM = {
           authContainer: document.getElementById('auth-container'),
           contentContainer: document.getElementById('content-container'),
           authButton: document.getElementById('authButton'),
           textRotator: document.getElementById('textRotator'),
           modalOverlay: document.getElementById('modalOverlay'),
           modalClose: document.getElementById('modalClose'),
           imageInput: document.getElementById('imageInput'),
           imagePreview: document.getElementById('imagePreview'),
           textInput1: document.getElementById('textInput1'),
           textInput2: document.getElementById('textInput2'),
           saveButton: document.getElementById('saveButton'),
           cancelButton: document.getElementById('cancelButton'),
           blurBackground: document.querySelector('.blur-background'),
           gradientMask: document.querySelector('.gradient-mask'),
           safeAreaGradient: document.querySelector('.safe-area-gradient')
       };
       
       // 文本轮换管理器
       const TextRotator = {
           currentIndex: 0,
           intervalId: null,
           
           init: function() {
               this.createTextElements();
               this.showText(0);
               this.startRotation();
           },
           
           createTextElements: function() {
               DOM.textRotator.innerHTML = '';
               
               AppState.customTexts.forEach((text, index) => {
                   const textElement = document.createElement('div');
                   textElement.className = 'rotating-text';
                   textElement.textContent = text;
                   textElement.dataset.index = index;
                   DOM.textRotator.appendChild(textElement);
               });
           },
           
           showText: function(index) {
               const texts = document.querySelectorAll('.rotating-text');
               
               texts.forEach(text => {
                   text.classList.remove('active', 'exiting');
               });
               
               if (texts[index]) {
                   texts[index].classList.add('active');
               }
               
               this.currentIndex = index;
           },
           
           nextText: function() {
               const texts = document.querySelectorAll('.rotating-text');
               const currentText = texts[this.currentIndex];
               
               if (currentText) {
                   currentText.classList.add('exiting');
               }
               
               const nextIndex = (this.currentIndex + 1) % texts.length;
               
               setTimeout(() => {
                   this.showText(nextIndex);
               }, CONFIG.textRotation.transitionDuration);
           },
           
           startRotation: function() {
               this.intervalId = setInterval(() => {
                   this.nextText();
               }, CONFIG.textRotation.interval);
           },
           
           stopRotation: function() {
               if (this.intervalId) {
                   clearInterval(this.intervalId);
                   this.intervalId = null;
               }
           },
           
           reset: function() {
               this.stopRotation();
               this.currentIndex = 0;
               this.showText(0);
               this.startRotation();
           },
           
           updateTexts: function(newTexts) {
               AppState.customTexts = newTexts;
               this.stopRotation();
               this.createTextElements();
               this.showText(0);
               this.startRotation();
           }
       };
       
       // 模态窗口管理器
       const ModalManager = {
           init: function() {
               DOM.textRotator.addEventListener('click', () => this.showModal());
               DOM.modalClose.addEventListener('click', () => this.hideModal());
               DOM.cancelButton.addEventListener('click', () => this.hideModal());
               DOM.saveButton.addEventListener('click', () => this.saveChanges());
               DOM.imageInput.addEventListener('change', (e) => this.handleImageUpload(e));
               
               DOM.modalOverlay.addEventListener('click', (e) => {
                   if (e.target === DOM.modalOverlay) {
                       this.hideModal();
                   }
               });
               
               this.loadSavedContent();
           },
           
           showModal: function() {
               DOM.textInput1.value = AppState.customTexts[0] || '';
               DOM.textInput2.value = AppState.customTexts[1] || '';
               
               if (AppState.customImage) {
                   DOM.imagePreview.style.backgroundImage = `url(${AppState.customImage})`;
               } else {
                   DOM.imagePreview.style.backgroundImage = "url('Mist.png')";
               }
               
               DOM.modalOverlay.classList.add('active');
               document.body.classList.add('no-scroll');
           },
           
           hideModal: function() {
               DOM.modalOverlay.classList.remove('active');
               document.body.classList.remove('no-scroll');
           },
           
           handleImageUpload: function(event) {
               const file = event.target.files[0];
               if (file) {
                   const reader = new FileReader();
                   reader.onload = function(e) {
                       DOM.imagePreview.style.backgroundImage = `url(${e.target.result})`;
                       AppState.tempImage = e.target.result;
                   };
                   reader.readAsDataURL(file);
               }
           },
           
           saveChanges: function() {
               const newTexts = [
                   DOM.textInput1.value || "霧",
                   DOM.textInput2.value || "Mist"
               ];
               
               TextRotator.updateTexts(newTexts);
               
               if (AppState.tempImage) {
                   AppState.customImage = AppState.tempImage;
                   this.updateImages();
                   AppState.tempImage = null;
               }
               
               this.saveContent();
               this.hideModal();
           },
           
           updateImages: function() {
               document.querySelector('.content-image').style.backgroundImage = `url(${AppState.customImage})`;
               DOM.blurBackground.style.backgroundImage = `url(${AppState.customImage})`;
               this.ensureImageCover();
           },
           
           ensureImageCover: function() {
               const images = [
                   document.querySelector('.content-image'),
                   DOM.blurBackground,
                   document.getElementById('imagePreview')
               ];
               
               images.forEach(img => {
                   if (img) {
                       img.style.backgroundSize = 'cover';
                       img.style.backgroundPosition = 'center';
                       img.style.backgroundRepeat = 'no-repeat';
                   }
               });
           },
           
           saveContent: function() {
               try {
                   localStorage.setItem('magicMist_customTexts', JSON.stringify(AppState.customTexts));
                   if (AppState.customImage) {
                       localStorage.setItem('magicMist_customImage', AppState.customImage);
                   }
               } catch (e) {
                   console.error("保存内容失败:", e);
               }
           },
           
           loadSavedContent: function() {
               try {
                   const savedTexts = localStorage.getItem('magicMist_customTexts');
                   if (savedTexts) {
                       AppState.customTexts = JSON.parse(savedTexts);
                   }
                   
                   const savedImage = localStorage.getItem('magicMist_customImage');
                   if (savedImage) {
                       AppState.customImage = savedImage;
                       this.updateImages();
                   }
               } catch (e) {
                   console.error("加载保存内容失败:", e);
               }
           }
       };
       
       // 认证管理器（简化版）
       const AuthManager = {
           init: function() {
               if (!window.PublicKeyCredential) {
                   DOM.authButton.disabled = true;
                   return;
               }
               
               this.checkExistingCredentials();
               DOM.authButton.addEventListener('click', () => this.startAuthentication());
               this.preventScroll();
           },
           
           preventScroll: function() {
               document.body.addEventListener('touchmove', function(e) {
                   e.preventDefault();
               }, { passive: false });
               
               document.addEventListener('scroll', function(e) {
                   e.preventDefault();
                   window.scrollTo(0, 0);
               });
           },
           
           checkExistingCredentials: function() {
               try {
                   const savedCredentialId = localStorage.getItem('webauthn_credential_id');
                   
                   if (savedCredentialId) {
                       AppState.credentialId = Uint8Array.from(savedCredentialId.split(',').map(Number));
                   }
               } catch (error) {
                   console.error("检查已保存凭证时出错:", error);
               }
           },
           
           startAuthentication: async function() {
               try {
                   DOM.authButton.disabled = true;
                   DOM.authButton.classList.add('auth-button-loading');
                   
                   if (AppState.credentialId) {
                       await this.authenticateWithCredential();
                   } else {
                       await this.registerNewCredential();
                   }
               } catch (error) {
                   console.error("认证失败:", error);
                   DOM.authButton.disabled = false;
                   DOM.authButton.classList.remove('auth-button-loading');
               }
           },
           
           registerNewCredential: async function() {
               const challenge = new Uint8Array(32);
               crypto.getRandomValues(challenge);
               
               const publicKey = {
                   challenge: challenge,
                   rp: { 
                       id: window.location.hostname, 
                       name: CONFIG.webauthn.rpName
                   },
                   user: {
                       id: new Uint8Array(16),
                       name: CONFIG.webauthn.userName,
                       displayName: CONFIG.webauthn.userDisplayName
                   },
                   pubKeyCredParams: [
                       { type: "public-key", alg: -7 }
                   ],
                   authenticatorSelection: {
                       userVerification: "required",
                       requireResidentKey: false
                   },
                   timeout: CONFIG.webauthn.timeout,
                   attestation: "none"
               };
               
               const credential = await navigator.credentials.create({ publicKey });
               
               if (credential && credential.rawId) {
                   AppState.credentialId = new Uint8Array(credential.rawId);
                   localStorage.setItem('webauthn_credential_id', Array.from(AppState.credentialId).join(','));
               }
               
               this.onAuthenticationSuccess();
           },
           
           authenticateWithCredential: async function() {
               const challenge = new Uint8Array(32);
               crypto.getRandomValues(challenge);
               
               const publicKey = {
                   challenge: challenge,
                   rpId: window.location.hostname,
                   allowCredentials: [
                       {
                           type: "public-key",
                           id: AppState.credentialId,
                           transports: ["internal"]
                       }
                   ],
                   userVerification: "required",
                   timeout: CONFIG.webauthn.timeout
               };
               
               const assertion = await navigator.credentials.get({ publicKey });
               
               if (assertion) {
                   this.onAuthenticationSuccess();
               } else {
                   throw new Error("认证失败");
               }
           },
           
           onAuthenticationSuccess: function() {
               AppState.isAuthenticated = true;
               UI.showContent();
           }
       };
       
       // UI管理器
       const UI = {
           showContent: function() {
               DOM.authContainer.style.opacity = "0";
               
               setTimeout(() => {
                   DOM.authContainer.style.display = "none";
                   DOM.contentContainer.style.display = "block";
                   DOM.contentContainer.offsetHeight;
                   
                   setTimeout(() => {
                       DOM.contentContainer.classList.add('active');
                       TextRotator.init();
                       ModalManager.ensureImageCover();
                   }, 50);
               }, 300);
           }
       };
       
       // 初始化应用
       function initApp() {
           AuthManager.init();
           ModalManager.init();
       }
       
       if (document.readyState === 'loading') {
           document.addEventListener('DOMContentLoaded', initApp);
       } else {
           initApp();
       }
       
       window.addEventListener('scroll', preventScroll, { passive: false });
       window.addEventListener('touchmove', preventScroll, { passive: false });
       
       function preventScroll(e) {
           e.preventDefault();
           window.scrollTo(0, 0);
           return false;
       }
   </script>
</body>
</html>
